---
title: 1.react基础用法之通信
categories: React
tags: react
date: 2022-10-05 10:28:00
---

## react基础用法
### state状态
> * setState处在同步逻辑中，异步更新状态，更新真实dom
> * setState处在异步逻辑中，同步更新状态，同步更新真实dom
> * setState处在同步逻辑中 接受第二个参数，第二个参数是回调函数，状态和dom更新完后就会被处罚

```bash
import BetterScroll from 'better-scroll';
    state = {
        list: []
    }
    render() {
        return (
            <div>
               <button onClick={() => this.getData()}>click</button>
                <div className='wrapper' style={{height: '200px', backgroundColor: 'red'}}>
                    <ul className='content' style={{height: '100%', overflow: 'auto'}}>
                        {
                            this.state.list.map(item => (
                                <li key={item}>{item}</li>
                            ))
                        }
                    </ul>
                </div>
            </div>
        )
    }
    getData () {
        let list = []
        for(let i = 0; i < 20; i++) {
            list.push(i)
        }
        this.setState({
            list: list
        }, () => {
            new BetterScroll('.content')
        })
    }
```

### 属性（props）
* `prop-types` 验证方法
* `propTypes` prop校验规则
* `defaultProps` 默认值
```bash
import kerwinPropTypes from 'prop-types'
export default class Navbar extends Component {
    # prop 验证写法一
    static propTypes = {
        title: kerwinPropTypes.string,
        leftShow: kerwinPropTypes.bool
    }
    # prop 默认值
    static defaultProps = {
        title: '首页1',
        leftShow: true
    }
    render () {
        return (
            <div>
                {this.props.leftShow && <button>返回</button>}
                navbar-{this.props.title}
                <button>home</button>
            </div>
        )
    }
}
# prop 验证写法二
Navbar.propTypes = {
    title: kerwinPropTypes.string,
    leftShow: kerwinPropTypes.bool
}
```

### 父子通信实战-表单处理
```bash
import React, { Component } from 'react'
# 子级组建
class Field extends Component {
    state = {
        value: ''
    }
    clear () {
        this.setState({
            value: ''
        })
    }
    setValue (value) {
        this.setState({
            value
        })
    }
    render () {
        return <div style={{background: '#ddd'}}>
            <label>{this.props.label}</label>
            <input type={this.props.type} onChange={(e) => {
                this.setValue(e.target.value)
            }} value={this.state.value}></input>
        </div>
    }
}
# 父级表单组建
export default class App extends Component {
    username = React.createRef()
    password = React.createRef()
    render() {
        return (
        <div>
            <h1>登录组建</h1>
            <Field label="用户名" type="text" ref={this.username}></Field>
            <Field label="密码" type="password" ref={this.password} ></Field>
            <button onClick={() => {
                console.log(this.username.current.state.value, 123123)
                console.log(this.password.current.state.value, 123123)
            }}>登录</button>
            <button onClick={() => {
                this.username.current.clear()
                this.password.current.clear()
            }}>取消</button>
        </div>
        )
    }
}
```

### 非父子组件通信
#### 1.状态提升（中间人模式）
在父级进行状态管理，子级参数互传，父级管理
```bash
export default class App extends Component {
    state = {
        filmList: [],
        synopsis: ''
    }
    constructor () {
        super()
        axios.get('/test.json').then(res => {
            this.setState({
                filmList: res.data.data.films
            })
        })
    }

    render() {
        return (
            <div>
            {
                this.state.filmList.map(item =><FilmItem key={item.filmId} {...item} onClickEvent={(value) => {
                    this.setState({
                        synopsis: value
                    })
                }}></FilmItem>)
            }
            <FilmDetail synopsis={this.state.synopsis}></FilmDetail>
            </div>
        )
    }
}

class FilmItem extends Component {
    render () {
        const {name, poster, synopsis} = this.props
        return (
            <div className='filmItem' onClick={() => this.props.onClickEvent(synopsis)}>
                <img src={poster} alt={name} />
                <h4>{name}</h4>
            </div>
        )
    }
}

class FilmDetail extends Component {
    render () {
        return (
            <div className='filmDetail'>{this.props.synopsis}</div>
        )
    }
}
```

#### 2.发布订阅设计模式
##### 初级代码
```bash
# 状态管理系统
let bus = {
    list: [],

    # 订阅
    subscribe (callback) {
        this.list.push(callback)
    },

    # 发布
    publish () {
        this.list.map(callback =>  callback && callback())
    }
}
# 订阅
bus.subscribe(() => {
    console.log(1111111111)
})
# 订阅
bus.subscribe(() => {
    console.log(22222222222)
})

// 发布者
bus.publish()
```

##### react 兄弟组件之间传参应用订阅模式
```bash
# 订阅发布系统
let bus = {
    list: [],

    # 订阅
    subscribe (callback) {
        this.list.push(callback)
    },

    # 发布
    publish (synopsis) {
        this.list.map(callback =>  callback && callback(synopsis))
    }
}

# 父级渲染，不作处理
export default class App extends Component {
    state = {
        filmList: [],
    }
    constructor () {
        super()
        axios.get('/test.json').then(res => {
            this.setState({
                filmList: res.data.data.films
            })
        })
    }

    render() {
        return (
            <div>
            {
                this.state.filmList.map(item =><FilmItem key={item.filmId} {...item} ></FilmItem>)
            }
            <FilmDetail></FilmDetail>
            </div>
        )
    }
}

# 列表子级 点击事件进行 发布模式
class FilmItem extends Component {
    render () {
        const {name, poster, synopsis} = this.props
        return (
            <div className='filmItem' onClick={() => {
                bus.publish(synopsis) # 调用发布
            }}>
                <img src={poster} alt={name} />
                <h4>{name}</h4>
            </div>
        )
    }
}
# 详情子级 初始化时 直接进行订阅
class FilmDetail extends Component {
    state = {
        synopsis: ''
    }
    constructor () {
        super()
        # 订阅模式
        bus.subscribe((test) => {
            this.setState({
                synopsis: test
            })
            console.log(test, '订阅')
        })
    }
    render () {
        return (
            <div className='filmDetail'>{this.state.synopsis}</div>
        )
    }
}
```

#### 3.context 
创建上下文对象
**GlobalContext.Provider**
**GlobalContext.Consumer**

```bash
# 父级 定义一个info状态变量
# 通过value里面定义setInfo进行状态修改，重来重新进行render渲染
class App extends Component {
    state = {
        filmList: [],
        info: ''
    }
    constructor () {
        super()
        axios.get('/test.json').then(res => {
            this.setState({
                filmList: res.data.data.films
            })
        })
    }

    render() {
        return (
            <GlobalContext.Provider value={{
                call: '打电话',
                sms: "短信",
                info: this.state.info,
                setInfo: (info) => {
                    this.setState({
                        info
                    })
                    console.log(this.state.info)
                }
            }}>
                <div>
                    {
                        this.state.filmList.map(item =><FilmItem key={item.filmId} {...item}></FilmItem>)
                    }
                    <FilmDetail></FilmDetail>
                </div>
            </GlobalContext.Provider>
            
        )
    }
}

class FilmItem extends Component {
    render () {
        const {name, poster, synopsis} = this.props
        return (
            <GlobalContext.Consumer>
                {
                    (value) => {
                        return (
                            <div className='filmItem' onClick={() => {
                                value.setInfo(synopsis)
                            }}>
                                <img src={poster} alt={name} />
                                <h4>{name}</h4>
                            </div>
                        )
                    }
                }
            </GlobalContext.Consumer>
            
        )
    }
}

class FilmDetail extends Component {
    render () {
        return (
            <GlobalContext.Consumer>
                {
                    (value) => <div className='filmDetail'>{value.info}</div>
                }
            </GlobalContext.Consumer>
            
        )
    }
}
```

### 插槽
#### 基本插槽的用法
> * 1.为了复用
> * 2.减少父子通信

```bash
class Child extends Component {
    render () {
        return (
            <div>
                Child
                {this.props.children[2]}
                {this.props.children[1]}
                {this.props.children[0]}
            </div>
        )
    }
}

class App extends Component {
  render() {
    return (
      <div>
        <Child title="12312321">
            <p style={{color: 'red', fontSize: '18px'}}>11111111</p>
            <p style={{color: 'red', fontSize: '18px'}}>222</p>
            <p style={{color: 'red', fontSize: '18px'}}>3333</p>
        </Child>
      </div>
    )
  }
}

```