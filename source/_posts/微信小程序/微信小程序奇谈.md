---
title: 微信小程序奇谈
categories: 微信小程序
tags: 微信
date: 2018-07-25 14:45:14 
---
更多资源来源于[微信开发文档](https://developers.weixin.qq.com/miniprogram/dev/index.html)

# 微信小程序的特点及不足
* 点击事件不支持ES6语法箭头函数
* 数据是单向绑定，改变js可以改变视图层的渲染，但是改变视图层无法改变js
* css样式的属性错误也不会报错或者划线划掉，会继续显示在样式列表中

# 配置问题

## app.json的常用配置

``` bash
    {
        "pages":[                     #设置页面路径
            "projets/index/welcome",
            "projets/practise/practise"
        ],
        "window":{                    #设置默认页面的窗口表现
            "navigationBarBackgroundColor": "#eee",      #导航栏背景颜色
            "navigationBarTextStyle": "black",           #导航栏标题颜色，仅支持 black/whit
            "navigationBarTitleText": "大帅比",          #导航栏标题文字内容
            "backgroundColor": "#f00",                  #窗口的背景色
            "backgroundTextStyle": "light"              #下拉 loading 的样式，仅支持 dark/light
        },
        "tabBar":{                    #设置底部tab的表现
            "color":"red",                              #文字默认颜色
            "selectedColor": "black",                   #文字选中时的颜色
            "backgroundColor": "#eee",                  #背景色
            "borderStyle": "black",                     #上边框的颜色
            "list": [{                                  #列表属性接受数组，最少2个、最多5个 
            "pagePath": "projets/index/welcome",        # 页面路径
            "text": "welcome",                          # 按钮文字
            "iconPath": "/images/qq.png",               #图片路径,限制为40kb，建议81px不支持网络图片
            "selectedIconPath":"/images/qq.png"         #选中时的图片路径限制为40kb建议81px
            },{
            "pagePath": "projets/practise/practise",    
            "text": "practise",                         
            "iconPath": "/images/wx.png",               
            "selectedIconPath": "/images/wx.png"        
            }]
        }
    }
```
pages属性中的设置会自动生成本地文件，同一文件下的文件名一致且必须一致，文件类型不同，不需要像html中link，scrpit-src引入。

# 以经典ofo小黄车微信小程序为例
微信小程序组建过多无法一次性学习所以组建，属性及功能，我们就碰到什么学习什么吧
## map地图组建的相关属性
* `latitude`,`longitude经纬度`;
* `scale`错放大小; 
* `show-location`个人定位; 
* `controls`控件 传一个数组
* `bindcontroltap` 点击事件，e事件源触发`controls`控件属性中的id

### 实例
```bash
<map 
    longitude='{{longitude}}' 
    latitude='{{latitude}}' 
    id='ofo-map' scale='16' 
    show-location controls='{{controls}}'
     bindcontroltap='bindcontroltap'
 />

# controls数组
controls:[{
    id: 1,
    iconPath: "/images/location.png",
    position: {
        width: 50,
        height: 50,
        left: 20,
        top: res.windowHeight - 80
    }
},{...},{...}]

```
## 框架->路由
### 路由的通用参数
* `url` 需要跳转的应用内非 tabBar 的页面的路径，路径后可以带参数。参数与路径之间使用?分隔，参数键与参数值用=相连，不同参数用&分隔；如 'path?key=value&key2=value2'
* `success` 接口调用成功的回调函数
* `fail` 接口调用失败的回调函数
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

### wx.redirectTo() 页面跳转 及数据的传输
关闭当前页面，跳转到应用内的某个页面。
```bash
# A组件的数据
wx.redirectTo({
    url: '../billing/index?password='+res.data.data.password + '&number=' + res.data.data.number,
})

# 传到B组件中 onLoad数据在中
onLoad: function (options) {
    console.log(options)
},
```
### wx.navigateTo()  页面跳转
保留当前页面，跳转到应用内的某个页面，使用wx.navigateBack可以返回到原页面。
```bash
wx.navigateTo({
    url: '../index/index?timer=' + this.timer,
})
```

### wx.navigateBack()
关闭当前页面，返回上一页面或多级页面。获取当前的页面栈，决定需要返回几层。
```bash
wx.navigateBack({
    delta: 1  
    # 1表示返回当前上一个页面，配合navigateTo使用。dalta的值可以改变2、3等效果内推
})
```

## 微信小程序的通用功能属性
### data-`index` 自定义事件 index是自定义的名称
实例 图片删除事件
```bash
# 此用于一点击事件处理 
<icon type="cancel" size="18" color="red" bindtap='delPic' data-index="{{index}}" ></icon>
# js
delPic: function(e){
    # index 获取的自定义事件的属性
    let index = e.target.dataset.index;
    # 获取原有属性的数组在进行处理
    var _picUrls = this.data.picUrls;
    _picUrls.splice(index, 1);
    this.setData({
      picUrls: _picUrls
    })
  },
```
### 创建及引用假数据
```bash
# 在根部创建一个data.js文档
var obj = {
  password: {
      data: {
        password: 1234,
        number: 66666
    }
  },
  success: {
      data:{
          data: 123
      }
  }
}
module.exports = obj

# 在组件中引入
var data = require("../../data/data.js");
console.log(data)
```

### v-for、v-if语法
#### v-for实例
```bash
<block wx:for='{{itemsValue}}' wx:key="{{index}}">
    <view class="grid">
        <checkbox value="{{item.valut}}" checked="{{item.checked}}" /> {{item.valut}}
    </view>
</block> 
```

#### v-if实例
```bash
<block wx:if="{{userInfo.userUrl  !== ''}}">
    <view class="img">
        <image src="{{userInfo.userUrl}}"></image>
    </view>
</block>
```
### for-of 遍历元素，同for-in同用处
#### 实例以添加照片为例
```bash
clickPhoto: function(){
    wx.chooseImage({
      success: (res)=>{
        # 获取微信实例上的picurls初始值，提取出来，在进行新值的添加
        var _picUrls = this.data.picUrls;
        var _tfs = res.tempFilePaths;
        for(let temp of _tfs){
          _picUrls.push(temp);
          this.setData({
            picUrls: _picUrls
          })
        }
      },
    })
  },
```

## button组件的相关属性
* `type` 按钮的样式类型: primary(绿色)  default(白色)  warn(红色)
* `bindtap` 绑定点击事件通用的属性
* `disabled` 是否禁用，默认值是false可以点击，true不可点击

### 实例
```bash
<button type="warn" bindtap="endride" disabled="{{clickBtn}}">结束骑行</button>
<button type="primary" bindtap="movetoindex">回到地图</button>
```

## input组件的绑定bindinput事件 
### 实例获取input.value的值
```bash
# dom
<input name="desc" placeholder='备注' bindinput='changeDesc'></input>
# js
changeNumber: function(e){
    this.setData({
      inputValue: {
        num: e.detail.value,
        desc: this.data.inputValue.desc
      }
    })
},
```

## checkbox-group 多项选择器，内部由多个checkbox组成。 
* `bindchange` 事件委托属性 事件源`e`监控说点击的信息，如：bindchange="changCheckbox"

### checkbox 多选项目 属性checked为false是不选中状态
### block dom碎片与for连用，不占dom结构
### wx:for 在组件上使用 wx:for 控制属性绑定一个数组，即可使用数组中各项的数据重复渲染该组件。

#### 实例
```bash
# wxml的配置 wx:for需要传数组
<checkbox-group class="choose-grids">
    <block wx:for='{{itemsValue}}' wx:key="{{index}}">
        <view class="grid">
            <checkbox value="{{item.valut}}" checked="{{item.checked}}" /> {{item.valut}}
        </view>
    </block>      
</checkbox-group>
# js
itemsValue: [{
      valut: "私锁私用",
      checked: false,
      color: '#b9dd08'
    }, {
        valut: "车牌缺损",
        checked: false,
        color: '#b9dd08'
      }, {
        valut: "轮胎坏了",
        checked: false,
        color: '#b9dd08'
      }]
```
## icon 图标组件
* `type` icon的类型
* `size` icon的大小，单位px
* `color` icon的颜色，同css的color
```bash
iconType: [
    'success', 'success_no_circle', 'info', 'warn', 'waiting', 'cancel', 'download', 'search', 'clear'
]
```
![icon图标样式]()

## 微信提供的调用接口
### wx.getLocation 移动端获取电脑ip经纬度
```bash
wx.getLocation({
    success: (res) =>{
        console.log(res)
        this.setData({
            latitude: res.latitude,
            longitude: res.longitude
        })
    },
})
```
### wx.getSystemInfo 获取此设备的硬件信息
```bash
wx.getSystemInfo({
    success:(res) =>{
        console.log(res);
        this.setData({
          controls:[{
            id: 1,
            iconPath: "/images/location.png",
            position: {
              width: 50,
              height: 50,
              left: 20,
              top: res.windowHeight - 80
            }
          }]
        })
    }
})
```                                                                                          
### wx.createMapContext(mapId, this) 创建并返回 map 上下文 mapContext 对象
```bash
# onShow中定义上下文，创建上下文对象参数为map标签的id
this.mapContext = wx.createMapContext("ofo-map");

# 创建movetoCenter函数 
movetoCenter: function(){
    #将地图中心移动到当前定位点，需要配合map组件的show-location使用
    this.mapctx.moveToLocation()
}
```
### wx.scanCode() 调用设备相册或照相机进行扫码
### wx.showLoading() 小弹框加载时用的 and wx.hideToast()取消加载的弹框
### wx.showToast()  打勾勾的弹窗
### wx.request() 跨域获取数据请求
```bash
wx.scanCode({ #扫码
    success: () =>{
        wx.showLoading({ #小弹框加载
            title: '正在获取密码',
        })
        wx.request({ #获取数据
            url: 'https://www.easy-mock.com/mock/5af6fdf7cd6ea04cb0708135/ofo/password',
            success: (res) =>{
                wx.hideLoading(); #取消小弹框加载
            }
        })
    },
    fail: () =>{
        console.log(222)
    }
})   
# 打勾勾的弹窗，duration延迟  
wx.showToast({
    title: '获取密码成功',
    duration: 1000
})
``` 
### wx.showToast  显示消息提示框 勾勾、加载等图标
* `title` 	提示的内容	
* `icon` 	图标，有效值 "success", "loading", "none"	
* `image` 	自定义图标的本地路径，image 的优先级高于 icon	1.1.0
* `duration` 提示的延迟时间，单位毫秒，默认：1500	
* `mask` 是否显示透明蒙层，防止触摸穿透，默认：false	
* `success` 接口调用成功的回调函数	
* `fail` 接口调用失败的回调函数	
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

实例
```bash
 wx.showToast({
    title: '提交成功',
    icon: "success"
})
```
### wx.showModal(OBJECT)显示模态弹窗
* `title` 提示的标题
* `content` 提示的内容
* `showCancel` 是否显示取消按钮，默认为 true
* `cancelText` 取消按钮的文字，默认为"取消"，最多 4 个字符
* `cancelColor` 取消按钮的文字颜色，默认为"#000000"
* `confirmText` 确定按钮的文字，默认为"确定"，最多 4 个字符
* `confirmColor` 确定按钮的文字颜色，默认为"#3CC51F"
* `success(res)` 接口调用成功的回调函数
    `confirm`	Boolean	为 true 时，表示用户点击了确定按钮	
    `cancel`	Boolean	为 true 时，表示用户点击了取消（用于 Android 系统区分点击蒙层关闭还是点击取消按钮关闭）	
* `fail` 接口调用失败的回调函数
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

实例
```bash
wx.showModal({
    title: '请填写完整反馈的信息',
    content: '你瞅啥，快去填，干你哦',
    confirmText: "我怂我填",
    cancelText: "劳资不填",
    success: function(res){
        if(res.confirm){
        # confirm 走的填写
        }else{
        wx.navigateBack({
                delta: 1
            })
        }
    }
})
```

### wx.chooseImage()  从本地相册选择图片或使用相机拍照。
* `count` 最多可以选择的图片张数，默认9
* `sizeType` original 原图，compressed 压缩图，默认二者都有
* `sourceType` album 从相册选图，camera 使用相机，默认二者都有
* `success` 成功则返回图片的本地文件路径列表 tempFilePaths
* `fail` 接口调用失败的回调函数
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

```bash
wx.chooseImage({
    success: (res)=>{}
        var _picUrls = this.data.picUrls;
        var _tfs = res.tempFilePaths;
        for(let temp of _tfs){
            _picUrls.push(temp);
            this.setData({
                picUrls: _picUrls,
                actionText: "+"
            })
        }
    },
})
```

### wx.login(OBJECT) 获取临时登录凭证（code）
* `timeout` 超时时间，单位 ms	1.9.90
* `success` 接口调用成功的回调函数	
* `fail` 接口调用失败的回调函数	
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

### wx.getUserInfo(Object object) 获取用户信息
button需要结合 **open-type="getUserInfo"**属性使用
* `withCredentials` 为 true 时需要先调用 wx.login 接口。需要用户授权 scope.userInfo。
注意：此接口有调整，参考公告 小程序与小游戏获取用户信息接口调整，请开发者注意升级。
* `withCredentials` 是否带上登录态信息。当 withCredentials 为 true 时，要求此前有调用过 wx.login 且登录态尚未过期，此时返回的数据会包含 encryptedData, iv 等敏感信息；当 withCredentials 为 false 时，不要求有登录态，返回的数据不包含 * * encryptedData, iv 等敏感信息。	
* `lang` 显示用户信息的语言	
* `success` 接口调用成功的回调函数	
* `fail` 接口调用失败的回调函数	
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

#### 实例运用
```bash
# button属性设置 getUserInfo很重要
<button bindtap='login' open-type="getUserInfo">登录</button>

# 获取
login: function(){
    wx.login({
        success: ()=>{
            wx.getUserInfo({
                success: (res) =>{
                    this.setData({
                    userInfo:{
                        userUrl: res.userInfo.avatarUrl,
                        nickname: res.userInfo.nickName
                    }
                    })
                }
            })
        }
    })
},
``` 
### wx.setStorage(OBJECT)
将数据存储在本地缓存中指定的 key 中，会覆盖掉原来该 key 对应的内容，这是一个异步接口。
* `key` 本地缓存中的指定的 key
* `data` 需要存储的内容
* `success` 接口调用成功的回调函数
* `fail` 接口调用失败的回调函数
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

### wx.getStorage(OBJECT)
从本地缓存中异步获取指定 key 对应的内容。
* `key` 本地缓存中的指定的 key
* `success` 接口调用的回调函数,res = {data: key对应的内容}
* `fail` 接口调用失败的回调函数
* `complete` 接口调用结束的回调函数（调用成功、失败都会执行）

### wx.removeStorage(OBJECT)
从本地缓存中异步移除指定 key 。

#### 实例
```bash
# 本地存储缓存指定的数据
wx.setStorage({
    key: 'userInfo',
    data: {
        # 这里的数据是在ofo中接口获取的用户名和头像地址
        userInfo: {
            userUrl: res.userInfo.avatarUrl,
            nickname: res.userInfo.nickName
        },
        actionText: "退出登录",
        btnType: "warn"
    },
})
# 本地获取缓存
wx.getStorage({
    key: 'userInfo',
    success: (res) => {
        this.setData({
            userInfo: {
                userUrl: res.data.userInfo.userUrl,
                nickname: res.data.userInfo.nickname
            },
            actionText: res.data.actionText,
            btnType: res.data.btnType
        })
    },
})

# 删除缓存
wx.removeStorageSync("userInfo")
```


